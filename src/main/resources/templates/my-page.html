<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/my-books-layout}">

<div layout:fragment="content">

    <!-- Start Breadcrumbs -->
    <div class="breadcrumbs">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6 col-md-6 col-12">
                    <div class="breadcrumbs-content">
                        <h1 class="page-title"></h1>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-12">
                    <ul class="breadcrumb-nav">
                        <li><a href="/"><i class="lni lni-home"></i> Home</a></li>
                        <li>마이페이지</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- End Breadcrumbs -->

    <!-- Start Faq Area -->
    <section class="faq section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div class="section-title">
                        <h2>마이페이지</h2>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-10 offset-lg-1 col-md-12 col-12">
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    <span class="title">회원정보 관리</span><i
                                        class="lni lni-plus"></i>
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <p><strong>이름:</strong> <span th:text="${user.name}"></span></p>
                                    <p><strong>Email:</strong> <span th:text="${user.email}"></span></p>
                                    <p><strong>핸드폰 번호:</strong> <span th:text="${user.phoneNumber}"></span></p>
                                    <p><strong>생일:</strong> <span th:text="${user.birth}"></span></p>
                                    <p><strong>마지막 로그인:</strong> <span th:text="${user.latestLogin}"></span></p>
                                    <p><strong>등급 변경일:</strong> <span th:text="${user.gradeChangedDate}"></span></p>
                                    <button type="button" class="btn btn-primary delete-btn" th:id="${userId}" th:onclick="'openWindow(' + ${userId} + ')'">수정</button>
                                </div>
                            </div>

                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    <span class="title">비밀번호 변경</span><i class="lni lni-plus"></i>
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <form id="changePasswordForm" action="/user/modify/password" method="post" onsubmit="return validatePassword()">
                                        <div class="form-group">
                                            <input type="password" id="password" class="form-control" name="password" placeholder="새 비밀번호" required>
                                        </div>
                                        <div class="form-group">
                                            <input type="password" id="confirmPassword" class="form-control" name="confirmPassword" placeholder="비밀번호 확인" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">변경</button>
                                    </form>
                                </div>
                            </div>
                        </div>


                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingThree">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseThree" aria-expanded="false"
                                        aria-controls="collapseThree">
                                    <span class="title">나중에 추가</span><i
                                        class="lni lni-plus"></i>
                                </button>
                            </h2>
                            <div id="collapseThree" class="accordion-collapse collapse"
                                 aria-labelledby="headingThree"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">

                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseFour" aria-expanded="false"
                                        aria-controls="collapseFour">
                                    <span class="title">나중에 추가</span><i
                                        class="lni lni-plus"></i>
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">

                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFive">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                        data-bs-target="#collapseFive" aria-expanded="false"
                                        aria-controls="collapseFive">
                                    <span class="title">회원탈퇴</span><i
                                        class="lni lni-plus"></i>
                                </button>
                            </h2>
                            <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive"
                                 data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <button class="btn btn-danger" onclick="confirmAndSubmit()">탈퇴</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- End About Area -->


    <!-- Start Team Area -->
    <section class="team section">
        <div class="container">
            <div class="row">
                <div class="col-lg-3 col-md-6 col-12">
                    <!-- Start Single Team -->
                    <div class="single-team">
                        <div class="content">
                            <div class="info">
                                <a href="/user">
                                    <h3>마이페이지</h3>
                                </a>
                            </div>
                        </div>
                    </div>
                    <!-- End Single Team -->
                </div>
                <div class="col-lg-3 col-md-6 col-12">
                    <!-- Start Single Team -->
                    <div class="single-team">
                        <div class="content">
                            <a href="/user/address">
                                <h3>주소관리</h3>
                            </a>
                        </div>
                    </div>
                    <!-- End Single Team -->
                </div>
                <div class="col-lg-3 col-md-6 col-12">
                    <!-- Start Single Team -->
                    <div class="single-team">
                        <div class="content">
                            <div class="info">
                                <h3>구매 목록</h3>
                            </div>
                        </div>
                    </div>
                    <!-- End Single Team -->
                </div>
                <div class="col-lg-3 col-md-6 col-12">
                    <!-- Start Single Team -->
                    <div class="single-team">
                        <div class="content">
                            <div class="info">
                                <h3>나중에 추가</h3>
                            </div>
                        </div>
                    </div>
                    <!-- End Single Team -->
                </div>
            </div>
        </div>
    </section>
    <!-- End Team Area -->

    <script>
        function confirmAndSubmit() {
            // 사용자에게 확인 창을 표시합니다.
            var confirmResign = confirm("정말 탈퇴하시겠습니까?");

            // 사용자가 "예"를 선택한 경우
            if (confirmResign) {
                // form 엘리먼트를 동적으로 생성합니다.
                var form = document.createElement('form');
                form.method = 'POST';  // POST 요청 설정
                form.action = '/user/delete';  // 요청할 URL 설정

                // form을 body에 추가합니다.
                document.body.appendChild(form);

                // form을 서브밋합니다.
                form.submit();
            } else {
                // 아무 동작도 하지 않습니다.
            }
        }

        function validatePassword() {
            // 새 비밀번호와 비밀번호 확인 값을 가져옵니다.
            var newPassword = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirmPassword').value;

            // 새 비밀번호와 비밀번호 확인이 일치하는지 확인합니다.
            if (newPassword !== confirmPassword) {
                // 일치하지 않는 경우 경고 메시지를 표시하고 폼을 제출하지 않습니다.
                alert("새 비밀번호와 비밀번호 확인이 일치하지 않습니다.");
                return false; // 폼 제출 방지
            }
            // 일치하는 경우 폼을 제출합니다.
            return true;
        }

        var newWindow;

        function openWindow(userId) {
            // 기존에 열려있는 창이 있다면 닫기
            if (newWindow && !newWindow.closed) {
                newWindow.close();
            }

            // 새 창 열기
            newWindow = window.open("", "NewWindow", "width=400,height=100");

            console.log(userId)

            // 새 창에 폼 내용 작성
            var content = `
        <html>
        <head>
            <title>회원 정보 수정</title>
            <!-- 필요한 CSS와 스타일을 추가하세요 -->
        </head>
        <body>
        <form id="modifyForm" method="post" action="/user/modify">
            <input type="hidden" name="userId" value="${userId}"/>

            <!-- 수정 양식 내용 -->
            <div class="form-group">
                <label for="modify_alias">이름</label>
                <input type="text" id="modify_alias" class="form-control" name="name" placeholder="이름" required>
            </div>
            <div class="form-group">
                <label for="modify_sample6_detailAddress">핸드폰번호</label>
                <input type="text" id="modify_sample6_detailAddress" class="form-control" name="phoneNumber" placeholder="핸드폰번호" required>
            </div>
            <button type="submit">변경</button>
        </form>
        </body>
        </html>
    `;

            // 새 창에 내용 쓰기
            newWindow.document.write(content);

            // 폼 제출 시 새 창 닫기
            newWindow.document.getElementById('modifyForm').addEventListener('submit', function (event) {
                event.preventDefault(); // 폼 제출 방지
                var form = event.target; // 폼 요소 가져오기
                var formData = new FormData(form); // 폼 데이터 생성
                var xhr = new XMLHttpRequest(); // XMLHttpRequest 객체 생성
                xhr.open('POST', form.action); // 요청 설정
                xhr.onload = function () {
                    // 요청 완료 시
                    if (xhr.status === 200) {
                        // 요청 성공 시
                        newWindow.close(); // 새 창 닫기
                        location.reload(); // 기존 페이지 새로고침
                    }
                };
                xhr.send(formData); // 요청 전송
            });
        }

        // 기존 창 닫기
        function closeWindow() {
            // 창 닫기
            newWindow.close();
        }

    </script>

</div>